---
title: "PEPA D칤a 1 - Clase 1"
author: "Arturo De Zan | Sergio Garcia Mora"
date: "11/6/2021"
output: 
  html_document:
    theme: spacelab
    highlight: textmate
    toc: true
    toc_float: true
    code_download: true
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
options(scipen = 999)
```

![](archivos/stats.png){width="421"}

# Introducci칩n

Este es un documento de `RMarkdown` que contiene c칩digo de R y que les permitir치 adem치s copiar y pegar el c칩digo en sus *scripts* para poner en pr치ctica los conceptos de estad칤stica.

Tambi칠n pueden extraer el c칩digo de este archivo, guardando el archivo `.Rmd` en la carpeta del proyecto y corriendo esta l칤nea de c칩digo en su consola.

```{r intro1, eval=FALSE}
knitr::purl("pepa_1.Rmd")
```

## Paquetes o librer칤as

Para realizar estos ejercicios van a necesitar instalar los siguientes paquetes o librer칤as. Este paso se realiza **una sola vez** por computadora.

```{r intro2, eval=FALSE}
install.packages("readxl")       # Lectura de archivos de Excel
install.packages("tidyverse")    # Limpieza, transformaci칩n y manipulaci칩n de datos
install.packages("funModeling")  # An치lisis exploratorio de datos
install.packages("summarytools") # Medidas de an치lisis estad칤stico
install.packages("lubridate")     # Manipulaci칩n de fechas
```

Luego, para utilizar las funciones de los paquetes que acabamos de instalar, necesitamos *"activar"* el paquete con la funci칩n `library()`.

```{r librer칤as}
library(readxl)
library(tidyverse)
library(funModeling)
library(lubridate)
library(summarytools)
```

# Carga de Datos

Vamos a utilizar dos archivos para trabajar. Uno llamado `plantel.xlsx` que es un listado de empleados, y el archivo `kiwi.csv` que contiene respuestas a la Encuesta KIWI de Sueldos de RRHH realizada por el Club de R para RRHH durante 2020.

> KIWI es un acr칩nimo de Key Investigation of Wages and Incomes.

```{r carga-datos}
# Carga de datos --------------------

# Un listado de empleados
plantel <- read_xlsx("datos/plantel.xlsx")

# Encuesta de Sueldos de RH 2020
kiwi <- read_delim("datos/kiwi_rh.csv", delim = ",") %>% 
  filter(pais == "Argentina")
```

## Limpieza y preparaci칩n de datos

Empezaremos a침adiendo algunas columnas adicionales al archivo `plantel.xlsx` en funci칩n de los campos `fecha_ingreso` y `fecha_nacimiento`.

```{r clean1}
plantel <- plantel %>% 
  mutate(anio_ingreso = floor_date(fecha_ingreso,
                                   unit = "year"),  # Extrae el a침o de la fecha ingreso
         q_ingreso = quarter(fecha_ingreso))  # Columna nueva con el trimestre


# Creamos una nueva columna uniendo las nuevas columnas que acabamos de crear
plantel$anioq_ingreso <- paste(plantel$anio_ingreso, plantel$q_ingreso, sep = "-")


# Creamos una columna con las generaciones a la que pertenecen los empleados
# Fuente: https://www.mckinsey.com/industries/consumer-packaged-goods/our-insights/true-gen-generation-z-and-its-implications-for-companies#
plantel <- plantel %>% 
  mutate(anio_nacimiento = year(fecha_nacimiento),
         generacion = case_when(
           anio_nacimiento <= 1959 ~ "Baby Boomer",
           anio_nacimiento <= 1979 ~ "Gen X",
           anio_nacimiento <= 1994 ~ "Gen Y",
           anio_nacimiento = TRUE  ~ "Gen Z"
  )) %>% 
  select(-anio_nacimiento) # Elimina la columna anio_nacimiento
```

# Distribuci칩n de Frecuencias

## Datos categ칩ricos o cualitativos

Calcular las frecuencias de una variable significa contar la cantidad de veces que aparece un valor de una variable.

Por ejemplo, del data frame `plantel` calculemos la cantidad de empleados por *Nivel de Contribuci칩n*.

```{r freq1}
plantel %>% 
  count(nivel_contribucion, sort = T)
```

Del data frame `kiwi` podemos calcular la cantidad de casos que permit칤an tomar mate en la oficina y los que no.

```{r freq2}
# Contar las empresas donde se pod칤a tomar mate en la oficina
kiwi %>% 
  filter(!is.na(mate)) %>% # Filtra las respuestas no nulas
  count(mate)
```

## Datos cuantitativos no agrupados

Utilizando nuevamente el data frame `plantel` analicemos la cantidad de contrataciones por trimestre desde el a침o 2016 en adelante.

```{r freq-cuant-no-a}
plantel %>%                           # Llama el dataframe 
  filter(anio_ingreso > 2018) %>%     # Filtra los ingresos posteriores al 2015
  count(anioq_ingreso)                # Cuenta la cantidad de ingresos por a침o y trimestre
```

Teniendo la cantidad de contrataciones por trimestre tambi칠n podemos calcular las:

-   **Distribuci칩n de frecuencias:** Que es el conteo de ingresos por trimestre.

-   **Frecuencias relativas:** Que es el *porcentaje* que representa el conteo sobre el total.

-   **Frecuencia relativas acumuladas:** Que representa el *porcentaje acumulado* de los ingresos de cada trimestre.

Para obtener estos resultados de manera simple, utilizaremos la funci칩n `freq()` del paquete `summarytools` :

```{r freq-cuant-no-a2}
plantel %>% 
  filter(anio_ingreso > 2018) %>%   # Filtramos los ingresos posteriores a 2015
  select(anioq_ingreso) %>%         # Seleccionamos la columna de trimestres
  freq(report.nas = FALSE)          # Calculamos las frecuencias omitiendo los NA
```

## Datos cuantitativos agrupados

Frecuentemente, la mejor forma de explicar los resultados de una variable **num칠rica** es agruparla en categor칤as que permitan contar mejor la historia de esos datos.

Por ejemplo, usemos la columna `contactos_linkedin` de la Encuesta KIWI.

```{r cuant-agrup1}
contactos <- kiwi %>%                  # Creamos un objeto nuevo llamado contactos
  select(contactos_linkedin) %>%       # Seleccionamos la columna 'contactos_linkedin'
  filter(!is.na(contactos_linkedin))   # Filtramos los datos nulos.

# Ver los primeros 50 resultados
contactos$contactos_linkedin[1:50]

```

Una forma de ver la **distribuci칩n** de los resultados es usando un tipo de gr치fico llamado **histograma**. Para ello usaremos la funci칩n `ggplot()` del paquete `ggplot2`.

```{r cuant-agrup2}

ggplot(contactos,                       # Nombre del data frame
       aes(x = contactos_linkedin)) +   # Variable que mapeamos en el eje x
  geom_histogram()                      # Tipo de gr치fico
```

En R hay m치s de una forma de hacer las cosas. Por ejemplo, usando el paquete `summarytools` podemos crear los grupos de manera m치s r치pida con la funci칩n `cut()` y con el par치metro `breaks` le indicamos la cantidad de grupos que queremos.

A continuaci칩n vamos a crear 5 grupos (`breaks = 5`) dividiendo en partes iguales a cada grupo. Lo que hace R con esto es tomar todo el rango de valores de la variable num칠rica y crea cinco secciones iguales.

```{r cuant-agrup5}
# Creamos una columna nueva para asignar los grupos
contactos$grupo <- cut(contactos$contactos_linkedin, 
                       breaks = 5) # Crea 5 grupos

# Calculamos las frecuencias por grupo
freq(contactos$grupo,
     report.nas = FALSE)
```

En ocasiones R, para simplificar la cantidad de ceros de una salidad de un c치lculo utiliza una codificaci칩n para indicar la cantidad de ceros que tiene el resultado..

En los ejemplos podemos ver que tenemos un 6^e+03^ lo que equivale a un *6* seguidos por 3 posiciones de ceros. Los restantes resultados se interpretan de la siguiente manera.

-   1.2^e+04^ = 12.000

-   1.8^e+04^ = 18.000

-   2.4^e+04^ = 24.000

-   3^e+04^ = 30.000

Como en R hay m치s de una forma de hacer las cosas, siempre vamos a estar tomando decisiones entre obtener lo que queremos m치s r치pido y con pocas l칤neas de c칩digo como vimos anteriormente, o bien, dedicar un poco m치s de esfuerzo en la preparaci칩n y limpieza para obtener algo m치s simple de entender despu칠s.

Otra forma de distribuir los resultados en categor칤as es usando un par de funciones de `tidyverse`. En esta opci칩n estamos creando categor칤as en base a un criterio arbitrario.

```{r cuant-agrup3}
contactos_2 <- contactos %>% 
  mutate(rango_contactos = case_when(          # Para crear categor칤as seg칰n el valor
    contactos_linkedin < 500   ~ "Hasta 500",          # Grupo 1
    contactos_linkedin < 2500  ~ "Entre 500 y 2500",   # Grupo 2
    contactos_linkedin < 5000  ~ "Entre 2500 y 5000",  # Grupo 3
    contactos_linkedin < 10000 ~ "Entre 5000 y 10000", # Grupo 4
    contactos_linkedin = T ~ "M치s de 10000"            # Grupo 5
  ),
  rango_contactos = factor(rango_contactos, 
                           levels = c("Hasta 500", "Entre 500 y 2500",
                                      "Entre 2500 y 5000", "Entre 5000 y 10000",
                                      "M치s de 10000"))) # Este es un paso necesario para que los grupos queden mejor ordenados.
```

Y ahora podemos calcular los rangos de frecuencia:

```{r cuant_agrup4}
contactos_2 %>% 
  select(rango_contactos) %>% 
  freq(report.nas = FALSE)
```

# Gr치ficos

## Gr치fico de barras

En la Encuesta KIWI se le pregunt칩 a las personas que les exigieron saber un idioma para ser contratadas, qu칠 porcentaje de su jornada, emplean ese idioma en su trabajo actual.

```{r col-plot}
# Preparaci칩n de los datos
idioma <- kiwi %>%                      # Creamos un nuevo data frame
  filter(!is.na(idioma_porcentaje),     # Filtro las respuestas nulas
         idioma_exigencia == "Si") %>%  # Filtro por las personas que s칤 les exigieron un idioma extranjero para entrar en su trabajo actual
  count(idioma_porcentaje)              # Cuenta la frecuencia por respuestas

# Realizo el gr치fico
ggplot(idioma,                            # Cargo el data frame 
       aes(x = factor(idioma_porcentaje), # Con factor() logro mostrar todas las etiquetas del eje
           y = n)) +                      # mapeo la columna n al eje y
  geom_col() +                            # Tipo de gr치fico
  # Agrega t칤tulo y subt칤tulo al gr치fico
  labs(title = "Porcentaje del tiempo usando idioma extranjero",
       subtitle = "Personas a las que les exigieron saber un idioma para ser contratadas")
```

## Histogramas

Los *histogramas* son gr치ficos que permiten conocer la distribuci칩n de una *variable num칠rica*.\

Para realizar nuestro histograma vamos a utilizar la columna `sueldo_bruto` de la Encuesta KIWI. Hagamos el gr치fico.

```{r hist1}
ggplot(kiwi, aes(x = sueldo_bruto)) +
  geom_histogram()
```

Nos sale un gr치fico horrible porque la presencia de valores **outliers** nos est치 "ensuciando" el gr치fico. Exploremos esta variable:

```{r hist2-eda}
summary(kiwi$sueldo_bruto)
```

Ac치 podemos percibir que el valor m칤nimo es \$ 0. Y que el valor m치ximo es \$ 2.140.000. As칤 que tenemos que buscar la forma de limpiar estos valores.

Una forma elegante de resolver este problema es buscando los valores que se encuentren entre los percentiles 5 y 95. En otras palabras vamos a hacer una **poda** de los extremos de la variable. Para ello vamos a usar un paquete que se llama `funModeling` y la funci칩n `profiling_num`

```{r hist3}
# Creamos un objeto con los resultados de la funci칩n
limpieza <- profiling_num(kiwi$sueldo_bruto)

# Veamos los valores almacenados
limpieza
```

Con esta funci칩n puedo saber que el sueldo en el percentil 5 es `r limpieza[1,6]` y que el valor en el percentil 95 es `r limpieza[1,10]`. Ahora puedo eliminar los valores que est칠n por debajo y por encima de esos percentiles para quedarme con las muestras m치s representativas.

Exploremos como quedan los valores ahora.

```{r hist4}
# Creo objetos almacenando los valores de los percentiles 5 y 95
p05 <- limpieza[1,6]
p95 <- limpieza[1,10]

# Creo un nuevo data frame llamado 'sueldos'
sueldos <- kiwi %>% 
  filter(tipo_contratacion != "Part time",  # Filtro los que no sean Part time
         between(sueldo_bruto,              # Variable a filtrar con 'between'
                 p05,                       # Filtro inferior
                 p95))                      # Filtro superior

# Exploremos la variable sueldo_bruto despu칠s de los filtros
summary(sueldos$sueldo_bruto)

```

Y ahora, con los datos limpios, probemos nuevamente de realizar nuestro histograma:

```{r hist5}
ggplot(sueldos, aes(x = sueldo_bruto)) +
  geom_histogram() +
  ggtitle("Histograma de Sueldo Bruto")
```

Ahora qued칩 algo con m치s onda 游땙

## Pol칤gono de frecuencia

Los pol칤gonos de frecuencia son una capa adicional que se puede agregar a los histogramas para a침adir m치s informaci칩n sobre la distribuci칩n.

Un detalle a tener en cuenta es que la cantidad de `bins` tiene que ser id칠ntica a la del histograma

```{r poli}
# Histograma con Pol칤gono de Frecuencias
ggplot(sueldos, aes(x = sueldo_bruto)) +
  geom_histogram(bins = 20) +                 # Modificamos la cantidad de grupos del histograma
    geom_freqpoly(aes(sueldo_bruto),          # A침adimos el pol칤gono de frecuencia
                bins = 20) +
  labs(title = "Histograma de Sueldo Bruto",  # Agrega titulo y subt칤tulo
       subtitle = "bins = 20") 

```

## Series de tiempo

Para esto usaremos una muestra de los datos de ingreso del dataframe `plantel` para ver la cantidad de personas contratradas por a침os desde el 2011 en adelante

```{r st}
# Creamos un nuevo dataframe filtrando los ingresos posteriores al 2010
ingresos <- plantel %>% 
  filter(year(fecha_ingreso) > 2010)

# Contamos la cantidad de ingresos por a침o
ingresos <- ingresos %>% 
  count(anio_ingreso)

# Veamos los resultados
ingresos
```

Con estos datos, ahora podemos hacer nuestro gr치fico:

```{r st2}
ggplot(ingresos, aes(x = anio_ingreso, y = n)) +
  geom_line()
```

## Gr치ficos de torta

Los gr치ficos de torta no son tan sencillos de hacer en R. En esencia lo que tenemos que hacer es un gr치fico de barras apilado al 100% y luego doblarlo para hacer el gr치fico de torta o de dona.

Cuando tienen pocas categor칤as (no m치s de 4 o 5 a lo sumo), los gr치ficos de torta son muy f치ciles de interpretar.

Vamos a graficar de la Encuesta KIWI, cu치ntos participantes fueron a universidades p칰blicas, privadas, y cu치ntos no fueron a la universidad. Primero creamos el dataframe

```{r pie1}
educ <- kiwi %>% 
  select(tipo_universidad) %>%    # Seleccionamos la columna tipo universidad
  group_by(tipo_universidad) %>%  # Agrupamos los resultados
  summarise (n = n()) %>%         # Contamos la cantidad de casos para cada grupo
  mutate(freq = n/sum(n)) %>%     # Creamos una columna nueva calculando la frecuencia relativa
  arrange(-n)                     # Ordenamos los resultados de mayor a menor

educ
```

Luego hay que computar los valores m칤nimos y m치ximos de cada rect치ngulo (recuerden que primero tenemos que hacer una barra.

```{r pie2}
# Calcular los porcentajes acumulados (tope de cada rect치ngulo)
educ$ymax <- cumsum(educ$freq)

# Calcula el l칤mite inferior
educ$ymin <- c(0, head(educ$ymax, n=-1))

educ
```

Y ahora podemos hacer el gr치fico. Este es el gr치fico que tenemos que "doblar".

```{r pie3}
ggplot(educ, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=tipo_universidad)) +
  geom_rect()
```

Y ahora s칤, podemos hacer el gr치fico de dona.

![](https://miro.medium.com/max/900/1*6JHx7caXdrL1SQ9mI3KRuA.jpeg){width="291"}

```{r pie4}
# Hacemos el gr치fico
ggplot(educ, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=tipo_universidad)) +
  geom_rect() +
  coord_polar(theta="y") + # Elimina esta l칤nea de c칩digo para entender lo que hace R.
  xlim(c(2, 4)) + # Prueben eliminando esta l칤nea de c칩digo para hacer un gr치fico de torta
  theme_void() +                             # Cambia est칠tica del gr치fico
  theme(legend.position = "left",            # Cambia la posici칩n de la leyenda
        plot.title.position = "plot") +      # Cambia la posici칩n del t칤tulo  
  labs(title = "Tipo de Universidad",
       fill = "Tipo de Universidad")
```

### M치s informaci칩n

El cap칤tulo 2 del libro [Un Recorrido por los M칠todos Cuantitativos en Ciencias Sociales a bordo de R](https://estadisticacienciassocialesr.rbind.io/distribuciones-de-frecuencia.html#tablas-univariadas) de Eduardo Bologna habla sobre **frecuencias**.

Para el tema de limpieza de datos, tenemos una [introducci칩n a tidyverse](https://youtu.be/-AXzusX4Cmo) que hicimos en el Club de R.

Sobre visualizaci칩n de datos tenemos el siguiente contenido:

[Introducci칩n a ggplot2](https://youtu.be/IdJ1UuEcCV8)

[Est칠tica de visualizaci칩n](https://youtu.be/Z2cGkNh1mVM)

[Microaprendizajes](https://youtu.be/lntmPdo8nbk) (peque침os tips sobre visualizaci칩n de datos y otras cosas m치s).

Algunos documentos complementarios:

[Introducci칩n a R](https://docs.google.com/document/d/1KCcrMDdEhp-4tw036DiNZqUGxMdBqztJ4Bfihqf4QUw/edit?usp=sharing)

[Introducci칩n a ggplot2](https://docs.google.com/document/d/1JAthc42Hno3tIhvZRrjA02zRCdS8q2uixODCBaZcPJ0/edit?usp=sharing)
